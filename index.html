<script>
// ======= CONFIG FIREBASE =======
const firebaseConfig = {
  apiKey: "AIzaSyCCheqFeLe-BS5ZZiyXLfmRVnyoDbmbMiM",
  authDomain: "absen-74c40.firebaseapp.com",
  databaseURL: "https://absen-74c40-default-rtdb.firebaseio.com",
  projectId: "absen-74c40",
  storageBucket: "absen-74c40.appspot.com",
  messagingSenderId: "962064220204",
  appId: "1:962064220204:web:8111b69ce31a5994f51189"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ======= DATA TERDAFTAR =======
const registeredUsers = {
    "200409":"Zendi Prianto",
    "110810":"Ramadhan",
    "111109":"M. Hafidz Atallah",
    "070909":"Fardan Rakhmansyah",
    "220209":"M. Ali Subechan",
    "120108":"M. Khafidz Affandy",
    "280508":"Nanda Alfares",
    "210707":"Irwandy Yusuf",
    "300310":"M. Sahrul Mubarok",
    "270810":"Bening Putriyanah",
    "210809":"Elisa Agustina",
    "240310":"Assyifa Nur Khasanah",
    "231109":"Vanesa Gresia Putri",
    "060209":"Asti Dwi Febriani",
    "051209":"Rahmatul Salimah",
    "140210":"Izzah Wardatil Millah",
    "110310":"Nur Laeli Rahma Tullah",
    "110210":"Ainum Mahmudah",
    "180210":"Dian Fakhrotun Nisa",
    "140510":"Uyun Dwi Risquna",
    "070110":"Ratih Rus Sukmah Watih",
    "070310":"Fannes Aisha Putri",
    "061108":"Naufal Rehan"
};

const batasJam = 18;

// ======= CEK SUDAH ABSEN HARI INI =======
function sudahAbsenHariIni(id, callback) {
    const now = new Date();
    const tgl = now.getDate();
    const bln = now.getMonth();
    const thn = now.getFullYear();

    db.ref("absensi").once("value", snapshot => {
        let sudah = false;

        snapshot.forEach(snap => {
            const item = snap.val();
            const w = new Date(item.waktu);

            if (item.id === id &&
                w.getDate() === tgl &&
                w.getMonth() === bln &&
                w.getFullYear() === thn) 
            {
                sudah = true;
            }
        });

        callback(sudah);
    });
}

// ======= Toggle input alasan =======
function toggleAlasanInput(){
    const status = document.getElementById("statusAbsen").value;
    document.getElementById("alasanWrapper").style.display = (status==="Izin") ? "block" : "none";
}

// ======= ABSENSI =======
function submitAbsensi(){
    const id = document.getElementById("userId").value.trim();
    const pesan = document.getElementById("pesan");
    const status = document.getElementById("statusAbsen").value;

    if(!id){pesan.style.color="red"; pesan.innerText="ID tidak boleh kosong!"; return;}
    if(!registeredUsers[id]){pesan.style.color="red"; pesan.innerText="ID tidak terdaftar!"; return;}

    const now = new Date();
    const hari = now.getDay();
    const jam = now.getHours();
    const menit = now.getMinutes();

    if(!(hari===2 || hari===6)){
        pesan.style.color="red"; 
        pesan.innerText="Absensi hanya hari Selasa & Sabtu!";
        return;
    }

    if (jam < 12 || (jam === 18 && menit > 0) || jam > 18) {
        pesan.style.color = "red";
        pesan.innerText = "Absensi hanya sampai pukul 18:00 WIB!";
        return;
    }

    // CEK DULU — SUDAH ABSEN ATAU BELUM
    sudahAbsenHariIni(id, (sudah)=>{
        if(sudah){
            pesan.style.color="red";
            pesan.innerText="Anda sudah absen hari ini!";
            return;
        }

        // Jika belum absen → lanjut submit
        let statusFinal = (status==="Hadir") 
            ? (jam < 18 || (jam===18 && menit===0) ? "Hadir" : "Tanpa Keterangan") 
            : "Izin";

        if(status==="Izin"){
            const alasan = document.getElementById("alasanIzin").value.trim();
            if(!alasan){
                pesan.style.color="red"; 
                pesan.innerText="Wajib menuliskan alasan izin!";
                return;
            }
            const data = {
                id:id, 
                nama:registeredUsers[id], 
                waktu:now.toLocaleString(), 
                status:statusFinal, 
                alasan:alasan
            };
            db.ref('absensi').push(data, err=>{
                if(err){pesan.style.color="red"; pesan.innerText="Gagal absen";}
                else{
                    pesan.style.color="green"; pesan.innerText="Absensi berhasil!";
                    document.getElementById("userId").value="";
                    document.getElementById("alasanIzin").value="";
                }
            });
        } else {
            const data = {
                id:id, 
                nama:registeredUsers[id], 
                waktu:now.toLocaleString(), 
                status:statusFinal
            };
            db.ref('absensi').push(data, err=>{
                if(err){pesan.style.color="red"; pesan.innerText="Gagal absen";}
                else{
                    pesan.style.color="green"; pesan.innerText="Absensi berhasil!";
                    document.getElementById("userId").value="";
                }
            });
        }
    });
}

// ======= ADMIN =======
function openAdmin(){document.getElementById("absenPage").style.display="none"; document.getElementById("adminLogin").style.display="block";}
function backToHome(){document.getElementById("adminLogin").style.display="none"; document.getElementById("absenPage").style.display="block";}
function loginAdmin(){
    const pass = document.getElementById("adminPass").value;
    if(pass==="fourl"){
        document.getElementById("adminLogin").style.display="none";
        document.getElementById("adminPanel").style.display="block";
        loadRekap();
    } else {
        document.getElementById("adminLoginMsg").innerText="Password salah!";
    }
}
function logoutAdmin(){
    document.getElementById("adminPanel").style.display="none"; 
    document.getElementById("absenPage").style.display="block";
}

// ======= REKAP =======
function loadRekap(){
    const body = document.getElementById("rekapBody");
    body.innerHTML="";
    db.ref('absensi').once('value', snapshot=>{
        snapshot.forEach(snap=>{
            const item = snap.val();
            const key = snap.key;
            const alasanText = item.alasan ? item.alasan : "-";
            body.innerHTML += `<tr>
                <td>${item.id}</td>
                <td>${item.nama}</td>
                <td>${item.waktu}</td>
                <td>${item.status}</td>
                <td>${alasanText}</td>
                <td><button onclick="hapusData('${key}')">Hapus</button></td>
            </tr>`;
        });
    });
}
function hapusData(key){
    db.ref('absensi/'+key).remove().then(()=>loadRekap());
}

// ======= AUTO TANPA KETERANGAN =======
function autoAbsenTanpaKeterangan(){
    const now = new Date();
    const hari = now.getDay();
    const jam = now.getHours();

    if((hari===2 || hari===6) && jam === 18){
        db.ref('absensi').once('value', snapshot=>{
            const sudahAbsen = {};
            snapshot.forEach(snap=>{
                const item = snap.val();
                const date = new Date(item.waktu);
                if(date.getDate()===now.getDate() &&
                   date.getMonth()===now.getMonth() &&
                   date.getFullYear()===now.getFullYear()){
                    sudahAbsen[item.id] = true;
                }
            });
            for(const id in registeredUsers){
                if(!sudahAbsen[id]){
                    db.ref('absensi').push({
                        id: id,
                        nama: registeredUsers[id],
                        waktu: now.toLocaleString(),
                        status: "Tanpa Keterangan"
                    });
                }
            }
        });
    }
}
setInterval(autoAbsenTanpaKeterangan, 60*1000);
</script>
